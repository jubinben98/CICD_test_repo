# CICD actions for the Application testing during the push at staging branch.

name: CICD Actions
on:
  push:
    branches:
      - staging

jobs:
  build-test:
    runs-on: windows-latest
    steps:

      # Checking out the code
      - name: Checkout the code.
        uses: actions/checkout@v2

      # Setting up the env
      - name: Setting the python environment.
        uses: actions/setup-python@v2
        with:
          python-version: 3.9.1

      # Installing the dependencies
      - name: Installing dependencies.
        run: |
          pip install -r .github/workflows/requirements.txt

      # Running the test cases
      - name: Run with pytest.
        run: |
          python -m pytest -v

 # Job for raising the pull request
  Raising-pull-request:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - uses: actions/checkout@v2
      - name: Raising PR to production
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "production"
          pr_title: "Automated PR from staging"
          pr_body: |
            Author          : ${{ github.actor }}
            Last Commit SHA : ${{ github.sha }}
            Full-reference  : ${{ github.ref }}
            Head-reference  : ${{ github.head_ref }}
            Base-reference  : ${{ github.base_ref }}
            Action Path     : ${{ github.action_path }}
            Event           : ${{ github.event }}
            Event-name      : ${{ github.event_name }}
            Event-path      : ${{ github.event_path }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

#  merge-to-production:
#    runs-on: ubuntu-latest
#    needs: build-test
#    steps:
#      - uses: actions/checkout@v2
#       # Push to the production branch
#      - name: Merge staging -> production
#        uses: devmasx/merge-branch@v1.3.1
#        with:
#          type: now
#          from_branch: staging
#          target_branch: production
#          github_token: ${{ github.token }}